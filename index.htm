<html>
  <head>
    <script src="https://unpkg.com/mithril/mithril.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css" integrity="sha384-X38yfunGUhNzHpBaEBsWLO+A0HDYOQi8ufWDkZ0k9e0eXz/tH3II7uKZ9msv++Ls" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/keyrune@latest/css/keyrune.css" rel="stylesheet" type="text/css" />
    <link href=" https://cdn.jsdelivr.net/npm/@saeris/typeface-beleren-bold@1.0.1/index.min.css " rel="stylesheet">
    <title>MTGCollector</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      body {
          line-height: 1.7em;
          color: #7f8c8d;
          font-size: 13px;
      }

      h1,
      h2,
      h3,
      h4,
      h5,
      h6,
      label {
          color: #34495e;
      }

      a {
          color: #1f8dd6;
          text-decoration: none;
      }

      .splash-container {
          background: linear-gradient(90deg, #00d2ff 0%, #3a47d5 100%);
          z-index: 1;
          overflow: hidden;
          width: 100%;
          height: 25%;
          top: 0;
          left: 0;
          position: fixed !important;
      }

      .splash-container h1 {
          font-size: 5em;
          font-weight: bold;
          color: white;
          padding: 1em 1.6em;
          font-weight: 100;
          border-radius: 5px;
          line-height: 1em;
          text-align: center;
          font-family: "Beleren Bold";
          text-shadow: 0px 0px 10px black;
      }

      .content-wrapper {
          position: absolute;
          top: 25%;
          width: 100%;
          min-height: 12%;
          z-index: 2;
          background: white;

      }

      #content {
          padding: 1em 1em 3em;
          max-width: 1280px;
          margin: 0 auto;
      }

      .footer {
          background: #111;
          position: fixed;
          bottom: 0;
          width: 100%;
          text-align: center;
      }

      .sets {
        display: grid;
      }
      .sets .set {
        margin: 1em;
        display: flex;
        flex-direction: row;
        background-color: #eee;
        padding: 1em;
        border-radius: 15px;
      }
      .sets .info {
        display: flex;
        flex-direction: column;
      }
      .sets .ss {
        font-size: 350%;
        width: 68px;
        color: #1f8dd6;
      }

      .sets a {
        font-size: 150%;
      }


      .cards {
        display: grid;
        grid-template-columns: auto auto auto auto;
      }
      .card {
        margin: 15px auto;
        display: flex;
        flex-direction: column;
        background-color: #eee;
        border-radius: 15px;
      }
      .card img {
        width: 250px;
        padding: 15px;
      }
      .card .info {
        display: flex;
        flex-direction: column;
        padding: 0 15px 15px 15px;
        line-height: 1.3;
      }
      .card .info .name {
        color: black;
        font-size: 110%;
      }


      .stats {
        display: flex;
      }
      .stats ul {
        margin: 0 2em 0 0;
      }

      @media (min-width: 48em) {
          body {
              font-size: 16px;
          }
          .sets {
            grid-template-columns: auto auto;
          }
      }

      @media (min-width: 78em) {
          .sets {
            grid-template-columns: auto auto auto;
          }
      }
    </style>
    <script>
      var set_data = [];
      var user_data = [];
      var card_sum = 0;
      var unique_editions = 0;
      var unique_cards = 0;
      var rares = 0;
      var uncommons = 0;
      var commons = 0;

      function loadUserData() {
        let ud = localStorage.getItem("user_data");
        if (ud == null) {
          return;
        }
        Papa.parse(ud, {
          complete: function(results) {
            user_data = results.data;
            card_sum = 0;
            unique_editions = 0;
            unique_cards = 0;
            rares = 0;
            uncommons = 0;
            commons = 0;

            user_data
              // filter out first item which is csv column names
              .filter((item, index, arr) => arr.indexOf(item) != 0)
              // sum all quanitity column values
              .map(x => card_sum += parseInt(x[6]));

            user_data
              // filter for rarity
              .filter(item => item[5] == "rare")
              // sum all quanitity column values
              .map(x => rares += parseInt(x[6]));

            user_data
              // filter for rarity
              .filter(item => item[5] == "uncommon")
              // sum all quanitity column values
              .map(x => uncommons += parseInt(x[6]));

            user_data
              // filter for rarity
              .filter(item => item[5] == "common")
              // sum all quanitity column values
              .map(x => commons += parseInt(x[6]));

            unique_editions = set_data
              // filter out first item which is csv column names
              .filter((item, index, arr) => arr.indexOf(item) != 0)
              // filter out editions that we don't have
              .filter(item => user_data.map(x => x[1]).indexOf(item[3]) != -1)
              .length;

            unique_cards = [...new Set(user_data.map(x => x[0]))].length;
            m.redraw()
          }
        });
      }

      function viewCard(item) {
        let img = "https://cards.scryfall.io/large/front/" + item[8][0] + "/" + item[8][1] + "/" + item[8] + ".jpg";

        return m("div", {class: "card"}, [
          m("img", {src: img}),
          m("div", {class: "info"}, [
            m("span", {class: "name"}, item[0]),
            m("span", "Unit Price: $" + item[9]),
            m("span", "Quantity: " + item[6])
          ])
        ]);
      }

      function onDOMReady() {
        var index = {
          view: function(vnode) {
            return [
              m("h1", "Upload Manabox .csv"),
              m("input", {type: "file", id: "csv", name: "csv", accept: "text/csv", onchange: function() {
                for (const file of event.target.files) {
                  const reader = new FileReader();
                  reader.onload = function(e) {
                    localStorage.setItem("user_data", reader.result);
                    loadUserData();
                  };
                  reader.readAsText(file);
                }
              }}),
              m("div", {style: {display: user_data.length > 0 ? "" : "none"}}, [
                m("h1", "Stats"),
                m("div", {class: "stats"}, [
                  m("ul", [
                    m("li", card_sum + " cards loaded"),
                    m("li", unique_cards + " unique cards"),
                    m("li", unique_editions + " unique editions"),
                  ]),
                  m("ul", [
                    m("li", rares + " rares"),
                    m("li", uncommons + " uncommons"),
                    m("li", commons + " commons")
                  ])
                ]),
                m("h1", "Search"),
                m("input", {type: "text", onkeyup: function(e) { if(e.code == "Enter") m.route.set("/search/:term", {term: this.value}) }}),
                m("h1", "Browse Sets"),
                m("div", {class : "sets"}, [
                  set_data
                    // filter out first item which is csv column names
                    .filter((item, index, arr) => arr.indexOf(item) != 0)
                    // filter out editions that we don't have
                    .filter(item => user_data.map(x => x[1]).indexOf(item[3]) != -1)
                    // sort by release date
                    .sort(function(a, b) {
                      return new Date(a[17]).getTime() - new Date(b[17]).getTime();
                    })
                    .map(function(item) {
                      return m("div", {class: "set"}, [
                        m("i", {class: "ss ss-" + item[3]}),
                        m("div", {class: "info"}, [
                          m(m.route.Link, {href: "/set/" + item[3]}, [
                            m("span", item[15])
                          ]),
                          m("span", item[17])
                        ])
                      ])
                    })
                  ]),
              ])
            ]}
        }

        var browse_set = {
          view: function(vnode) {
            return [
              m("h1", "Browsing " + set_data.filter(x => x[3] == vnode.attrs.set)[0][15]),
              m("div", {class: "cards"}, [
                user_data
                  .filter(item => item[1] == vnode.attrs.set)
                  .map(viewCard)
              ]),
            ]
          }
        }

        var search_result = {
          view: function(vnode) {
            return [
              m("h1", "Search Result for " + vnode.attrs.term),
              m("div", {class: "cards"}, [
                user_data
                  .filter(item => item[0].toLowerCase().indexOf(vnode.attrs.term.toLowerCase()) > -1)
                  .map(viewCard)
              ]),
            ]
          }
        }

        m.route(document.getElementById("content"), "/", {
          "/": index,
          "/set/:set": browse_set,
          "/search/:term": search_result
        });

        Papa.parse("https://mtgjson.com/api/v5/csv/sets.csv", {
          download: true,
          complete: function(results) {
            set_data = results.data;
            loadUserData();
          }
        });

      }

      document.addEventListener("DOMContentLoaded", onDOMReady);
    </script>
  </head>
  <body>
    <div class="splash-container">
      <h1>MTGCollector</h1>
    </div>
    <div class="content-wrapper">
        <div id="content">

        </div>
        <div class="footer"> (C) 2025 8bitmcu</div>
    </div>
  </body>
</html>
